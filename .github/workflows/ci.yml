name: CI

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

jobs:
  test:
    name: Test
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
      with:
        xcode-version: latest-stable
    
    - name: Show Swift version
      run: swift --version
    
    - name: Build
      run: make build
    
    - name: Run tests
      run: make test
    
    - name: Build app bundle
      run: make app
    
    - name: Verify app bundle
      run: |
        test -f build/LogseqTodo.app/Contents/MacOS/LogseqTodo
        test -f build/LogseqTodo.app/Contents/Info.plist
        echo "âœ… App bundle verification passed"

  lint:
    name: Swift Lint
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
      with:
        xcode-version: latest-stable
    
    - name: Build for type checking
      run: swift build

  release:
    name: Create Release Artifacts
    runs-on: macos-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [test, lint]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
      with:
        xcode-version: latest-stable
    
    - name: Create release build
      run: make release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: logseq-todo-release
        path: |
          LogseqTodo-*.zip
          LogseqTodo-*.zip.sha256
        retention-days: 30
