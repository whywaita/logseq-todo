name: CI

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

jobs:
  test:
    name: Test
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
      with:
        xcode-version: latest-stable
    
    - name: Show Swift version
      run: swift --version
    
    - name: Build
      run: make build
    
    - name: Run tests
      run: make test
    
    - name: Build app bundle
      run: make app
    
    - name: Verify app bundle
      run: |
        test -f build/LogseqTodo.app/Contents/MacOS/LogseqTodo
        test -f build/LogseqTodo.app/Contents/Info.plist
        echo "âœ… App bundle verification passed"

  lint:
    name: Swift Lint
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
      with:
        xcode-version: latest-stable
    
    - name: Build for type checking
      run: swift build

  release:
    name: Create Release Artifacts
    runs-on: macos-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [test, lint]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
      with:
        xcode-version: latest-stable
    
    - name: Create release build
      run: make release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: logseq-todo-release
        path: |
          LogseqTodo-*.zip
          LogseqTodo-*.zip.sha256
        retention-days: 30
